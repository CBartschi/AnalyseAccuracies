---
title: "Accuracies_GS_LV"
author: "Cédric Bärtschi"
date: '`r format(Sys.time(), "%d %B, %Y")`'
output:
  html_document: default
  pdf_document: default
  word_document: default
---

```{r setup, include=FALSE, }
rm(list = ls())

library(ggplot2)
library(plyr)
library(dplyr)
library(ggpubr)
library(knitr)
today <- as.character(Sys.Date())
today <- gsub("-", x=today, "")

# Set WD ------------------------------------------------------------------
office="CIRAD"

if (office=="CIRAD"){
  root <- "D:/Mes Donnees/"
} else {
  root <- "C:/Users/cedri/"
}
knitr::opts_knit$set(root.dir=paste0(root,"OneDrive/A_GenomicPrediction/PredictionASReml/GS_VL/S02S03_rerun/"))
# output
output <- paste0(root, "OneDrive/DOC/Writing/Paper1/FigureTable/output/")

```


```{r function summTable, include=FALSE}
summTable_fun <- function(x){
  lmd <- x$lmobj
  tr <- x$tr
  
  r2 <- round(summary(lmd)$r.square, 3)
  
  df <- data.frame("Trait"=c(as.character(tr), rep(NA, times=(nrow(anova(lmd))-1))),
                   "Variable"=rownames(anova(lmd)),
                   anova(lmd),
                   "R2"=c(r2, rep(NA, times=(nrow(anova(lmd))-1))))
  rownames(df)=NULL
  df[,4:7] <- apply(df[,4:7], 2, function(x) round(x, 3))
  
  df[,7][df$Pr..F.==0] <- "<0.001"
  
  return(df)
}
```


```{r load and prepare files, include=FALSE}
# File Input  -------------------------------------------------------------

Acc_input <- "Accuracies_20200724.csv"
sumAcc_input <- "summary_Accuracy_20200724.csv"

# Load files --------------------------------------------------------------

Acc_infile <- read.csv(Acc_input,
                       header = TRUE)
Acc <- Acc_infile

summAcc_intput <- read.csv(paste0(sumAcc_input),
                           header = TRUE)
summAcc<- summAcc_intput

# Prepare df --------------------------------------------------

# Acc
levels(Acc$CV) <- c(levels(Acc$CV), "CV2")
Acc$CV[Acc$CV=="CV2_site"] <- "CV2"
Acc$CV <- factor(Acc$CV, levels = c("CV2", "IMBran", "IMBcdm", "IMBcdm_Gmat", "IMBcdm_Kmat"))

levels(Acc$LOC) <- c(levels(Acc$LOC), "PAL", "SRO")
Acc$LOC[Acc$LOC=="PA"] <- "PAL"
Acc$LOC[Acc$LOC=="SR"] <- "SRO"

levels(Acc$trait) <- c(levels(Acc$trait), "YLD")
Acc$trait[Acc$trait=="YLD14"] <- "YLD"
Acc$trait <- factor(Acc$trait, levels = c("FL", "PH", "YLD", "ZN"))

colnames(Acc)[colnames(Acc)=="Predictor"] <- "Generation"

Acc$s[Acc$s==0.3] <- 234
Acc$s <- as.factor(Acc$s)

Acc <- within(Acc, {
  xlabel <- ifelse(Acc$CV=="CV2", paste0(as.character(Acc$LOC), " ", as.character(Acc$s)), as.character(Acc$s))
})

Acc$xlabel <- factor(Acc$xlabel, levels = c("PAL 234", "SRO 234", "25", "50", "100", "200"))
colnames(Acc)[colnames(Acc)=="V1"] <- "mean"

Acc <- droplevels(Acc)

# summAcc
levels(summAcc$CV) <- c(levels(summAcc$CV), "CV2")
summAcc$CV[summAcc$CV=="CV2_site"] <- "CV2"
summAcc$CV <- factor(summAcc$CV, levels = c("CV2", "IMBran", "IMBcdm", "IMBcdm_Gmat", "IMBcdm_Kmat"))

levels(summAcc$LOC) <- c(levels(summAcc$LOC), "PAL", "SRO")
summAcc$LOC[summAcc$LOC=="PA"] <- "PAL"
summAcc$LOC[summAcc$LOC=="SR"] <- "SRO"

levels(summAcc$trait) <- c(levels(summAcc$trait), "YLD")
summAcc$trait[summAcc$trait=="YLD14"] <- "YLD"
summAcc$trait <- factor(summAcc$trait, levels = c("FL", "PH", "YLD", "ZN"))

colnames(summAcc)[colnames(summAcc)=="Predictor"] <- "Generation"

summAcc$s[summAcc$s==0.3] <- 234
summAcc$s <- as.factor(summAcc$s)

summAcc <- within(summAcc, {
  xlabel <- ifelse(summAcc$CV=="CV2", paste0(as.character(summAcc$LOC), " ", as.character(summAcc$s)), as.character(summAcc$s))
})

summAcc$xlabel <- factor(summAcc$xlabel, levels = c("PAL 234", "SRO 234", "25", "50", "100", "200"))

summAcc <- droplevels(summAcc)

```
Acc_input <- "Accuracies_20200713.csv"
sumAcc_input <- "summary_Accuracy_20200713.csv"
#Data
Acc: `r Acc_input`  
sumAcc:`r sumAcc_input`


Data graph
```{r data fig, echo=TRUE}
dataPA <- summAcc

datarkhs <- droplevels(dataPA[dataPA$CV %in% c("IMBcdm_Gmat", "IMBcdm_Kmat", "IMBran") & dataPA$method=="RKHS",])

datarkhs$z <- (0.5 * (log(1+datarkhs$mean) - log(1-datarkhs$mean)))
datarkhs$s <- as.factor(datarkhs$s)
```

#Résultat
## RKHS matrix effect
```{r plot, echo=FALSE}
  ggplot(datarkhs, 
       aes(x=xlabel, y= mean, group=CV, label=sprintf("%0.2f", round(mean, digits = 2))))+
  geom_errorbar(aes(ymin=mean-sd, ymax=mean+sd), width=.2, position=position_dodge(0.5))+
  geom_point(aes(color = CV), position=position_dodge(0.5))+ #shape = Proxy
  facet_grid(trait~Generation, scales = "free_y")+
  # ggtitle("Size comparison")+
  # ylab("Cor(GEBV, Yref)")+
  ylab("cor(GEBV, Yref)")+
  xlab("SRO set size")+
  scale_colour_manual(values = c("blue", "red", "darkgreen"))+
  theme_light()+
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 90))+
  scale_y_continuous(labels = function(x) sprintf("%0.2f", round(x, 2)))+
  theme(strip.background =element_blank(),
        strip.text = element_text(colour = "black"))
```

## Gmat vs Kmat
```{r anova Gmat vs Kmat, echo=FALSE}
# levels(datarkhs$CV)
# 
# c1 <- c(0,1,-1)
# c2 <- c(1, -0.5, -0.5)
# 
# mat <- rbind(constant=1/3, c1, c2)
# matC <- solve(mat)
# matC <- matC[,-1]

rkhs_lmMain <- dlply(datarkhs, .(trait), function(x) lm_out <- list(lmobj=lm(z ~ Generation + CV + s, data =x[x$CV!="IMBran",]),
                                                                  tr=x$trait[1]))

# rkhs_lmMain <- dlply(datarkhs, .(trait), function(x, cntr=matC) lm_out <- list(lmobj=lm(z ~ Generation + CV + s, 
#                                                                                         data =x),
#                                                                   tr=x$trait[1]))


summTable_rkhs <- ldply(.data=rkhs_lmMain, .fun=summTable_fun)
summTable_rkhs$Trait <- as.character(summTable_rkhs$Trait)
summTable_rkhs[is.na(summTable_rkhs)] <- ""
kable(summTable_rkhs[,-1])

```

## IMBran vs Kmat  
```{r ran vs Kmat}
rkhs_lmMain <- dlply(datarkhs, .(trait), function(x) lm_out <- list(lmobj=lm(z ~ Generation + CV + s, data =x[x$CV!="IMBcdm_Gmat",]),
                                                                  tr=x$trait[1]))

summTable_rkhs <- ldply(.data=rkhs_lmMain, .fun=summTable_fun)
summTable_rkhs$Trait <- as.character(summTable_rkhs$Trait)
summTable_rkhs[is.na(summTable_rkhs)] <- ""
kable(summTable_rkhs[,-1])
```

## IMBran vs Gmat  
```{r ran vs Gmat}
rkhs_lmMain <- dlply(datarkhs, .(trait), function(x) lm_out <- list(lmobj=lm(z ~ Generation + CV + s, data =x[x$CV!="IMBcdm_Kmat",]),
                                                                  tr=x$trait[1]))

summTable_rkhs <- ldply(.data=rkhs_lmMain, .fun=summTable_fun)
summTable_rkhs$Trait <- as.character(summTable_rkhs$Trait)
summTable_rkhs[is.na(summTable_rkhs)] <- ""
kable(summTable_rkhs[,-1])
```

## Data table
```{r data table, echo=TRUE}
kable(datarkhs)
